#!/bin/bash
cd "${0%/*}" || exit                                # Run from this directory
. ${WM_PROJECT_DIR:?}/bin/tools/RunFunctions        # Tutorial run functions
#------------------------------------------------------------------------------

# Check smoothing argument
if [ -z "$1" ]; then
    echo "No argument supplied. Using default value: false"
    smoothing="false"
else
    smoothing=$1
fi
#
# Create grid
runApplication blockMesh
    
# Check cfMesh availability and smooth grid with improveMeshQuality utility
if [ "$smoothing" = "true" ]; then
    if command -v myimproveMeshQuality >/dev/null 2>&1; then
	runApplication -s smoothing decomposePar -constant
    runParallel -s smoothing topoSet -dict system/topoSetDict.smoothing
	runParallel checkMesh
    runParallel myimproveMeshQuality -constrainedCellSet protected_cells
	runApplication -s smoothing reconstructParMesh -constant -fullMatch
	runParallel -s decompose redistributePar -decompose -constant -overwrite
    runParallel -s smoothed checkMesh -allTopology -allGeometry -constant
    else
        echo "improveMeshQuality command not found. Please install cfMesh"
        echo "integration to use smoothing."
        echo "Skipping smoothing..."
        runParallel -s decompose redistributePar -decompose -constant -overwrite
        runParallel checkMesh
    fi
fi

# improveMeshQuality does not preserve cellZones
# => workaround with different dictionary or re-run.
# leave this to point out the utility reuired fix
runParallel -s smoothing.again topoSet -dict system/topoSetDict.smoothing
runParallel -s refinement topoSet -dict system/topoSetDict.refinement

# Renumber
runParallel renumberMesh -overwrite -constant

#------------------------------------------------------------------------------
