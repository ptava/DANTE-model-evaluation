#!/bin/bash
cd "${0%/*}" || exit                                # Run from this directory
. ${WM_PROJECT_DIR:?}/bin/tools/RunFunctions        # Tutorial run functions
#------------------------------------------------------------------------------

# Check smoothing argument
if [ -z "$1" ]; then
    echo "No argument supplied. Using default value: False"
    smoothing="false"
else
    smoothing=$1
fi

# Run applications: create grid
runApplication blockMesh
runApplication checkMesh
runApplication -s smoothing topoSet -dict system/topoSetDict.smoothing
    
# Check cfMesh availability (we'll use improveMeshQuality utility)
if [ "$smoothing" = "true" ]; then
    if command -v myimproveMeshQuality >/dev/null 2>&1; then
        runApplication myimproveMeshQuality \
            -constrainedCellSet protected_cells
        runApplication -s smoothed checkMesh \
            -allTopology -allGeometry -constant
    else
        echo "improveMeshQuality command not found. Please install cfMesh"
        echo "integration to use smoothing."
        echo "Skipping smoothing..."
    fi
fi

# improveMeshQuality does not preserve cellZones
# workaround with different dictionary or re-run.
# leave this to point out the utility reuired fix
runApplication -s refinement topoSet -dict system/topoSetDict.refinement

# Renumbering
runApplication renumberMesh -overwrite -constant

# Copy initial conditions
cp -r 0.orig 0
#------------------------------------------------------------------------------
